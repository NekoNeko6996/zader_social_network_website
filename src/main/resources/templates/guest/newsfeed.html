<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <!--head-->
    <head th:replace="~{fragments/head :: common-head}"></head>

    <body class="bg-background font-display text-text-primary">
        <div class="relative flex min-h-screen w-full flex-col">
            <!-- Header -->
            <div th:replace="~{fragments/header :: header}"></div>

            <!-- Main Content -->
            <main class="mx-auto w-full max-w-7xl flex-1 p-4 md:p-6 lg:p-8">
                <div class="grid grid-cols-12 gap-6 lg:gap-8">
                    <!-- Left Sidebar -->
                    <aside class="hidden lg:col-span-3 lg:block">
                        <div class="sticky top-24 flex flex-col gap-6">
                            <div class="flex flex-col gap-2 rounded-lg bg-container p-4 shadow-sm">
                                <a class="flex items-center gap-3 rounded-lg bg-secondary-accent/10 px-3 py-2 text-secondary-accent" href="#">
                                    <span class="material-symbols-outlined">home</span>
                                    <p class="text-sm font-bold">Home</p>
                                </a>
                                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-secondary transition-colors hover:bg-gray-100" href="#">
                                    <span class="material-symbols-outlined">group</span>
                                    <p class="text-sm font-medium">Friends</p>
                                </a>
                                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-secondary transition-colors hover:bg-gray-100" href="#">
                                    <span class="material-symbols-outlined">person</span>
                                    <p class="text-sm font-medium">Profile</p>
                                </a>
                                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-text-secondary transition-colors hover:bg-gray-100" href="#">
                                    <span class="material-symbols-outlined">settings</span>
                                    <p class="text-sm font-medium">Settings</p>
                                </a>
                            </div>
                        </div>
                    </aside>
                    <!-- Center Feed -->
                    <div class="col-span-12 lg:col-span-6">
                        <div class="flex flex-col gap-6">
                            <div class="flex flex-col gap-4 rounded-lg bg-container p-4 shadow-sm">
                                <div sec:authorize="isAuthenticated()" class="flex flex-col gap-4 rounded-lg bg-container p-4 shadow-sm">
                                    <form th:action="@{/post/create}" th:object="${postCreateDto}" method="post" enctype="multipart/form-data">
                                        <div class="flex items-start gap-4">
                                            <div class="h-10 w-10 flex-shrink-0 rounded-full bg-cover bg-center bg-no-repeat" 
                                                 th:style="'background-image: url(' + 
                                                 (${#authentication.principal != 'anonymousUser'} and ${#authentication.principal.member.avatarUrl != null} 
                                                 ? @{'/uploads/' + ${#authentication.principal.member.avatarUrl}} 
                                                 : '/images/default-avatar.png') + ');'">
                                            </div>
                                            <textarea th:field="*{content}" 
                                                      class="form-textarea flex-1 resize-none rounded-lg border-gray-200 bg-background p-3 text-text-primary placeholder:text-text-secondary focus:border-secondary-accent focus:ring-secondary-accent" 
                                                      placeholder="Share what's new..." rows="3" required></textarea>
                                        </div>

                                        <div id="image-preview-container" class="hidden mt-2 relative">
                                            <img id="image-preview" src="#" alt="Image Preview" class="max-h-60 rounded-lg border border-gray-200">
                                            <button type="button" onclick="removeImage()" class="absolute top-1 right-1 bg-gray-800 text-white rounded-full p-1 text-xs">✕</button>
                                        </div>

                                        <div class="flex items-center justify-between mt-3">
                                            <div class="flex items-center gap-2">
                                                <button type="button" onclick="document.getElementById('fileInput').click()" 
                                                        class="flex h-9 w-9 items-center justify-center rounded-full text-text-secondary transition-colors hover:bg-gray-100">
                                                    <span class="material-symbols-outlined text-xl">image</span>
                                                </button>
                                                <input type="file" id="fileInput" th:field="*{imageFile}" class="hidden" accept="image/*" onchange="previewImage(this)">

                                            </div>
                                            <button type="submit" class="h-9 cursor-pointer items-center justify-center rounded-lg bg-primary-cta px-6 text-sm font-bold text-white shadow-sm transition-opacity hover:opacity-90">Post</button>
                                        </div>
                                    </form>
                                </div>

                                <div sec:authorize="!isAuthenticated()" class="flex flex-col gap-4 rounded-lg bg-container p-4 shadow-sm text-center">
                                    <p class="text-text-secondary">Please <a th:href="@{/login}" class="text-primary-cta font-bold hover:underline">Login</a> to share your thoughts.</p>
                                </div>
                            </div>

                            <div th:each="post : ${posts}" class="flex flex-col rounded-lg bg-container shadow-sm">
                                <div class="flex items-center gap-3 p-4">
                                    <div class="h-10 w-10 flex-shrink-0 rounded-full bg-cover bg-center" 
                                         th:style="'background-image: url(' + @{'/uploads/' + ${post.member.avatarUrl != null ? post.member.avatarUrl : '/default/default-avatar.png'}} + ');'"></div>

                                    <div class="flex flex-col">
                                        <p class="font-bold text-text-primary" th:text="${post.member.fullName != null ? post.member.fullName : post.member.username}">Author Name</p>
                                        <p class="text-xs text-text-secondary" th:text="${#temporals.format(post.createdAt, 'dd-MM-yyyy HH:mm')}">Time</p>
                                    </div>
                                </div>

                                <div class="px-4 pb-4">
                                    <p class="text-text-primary whitespace-pre-wrap" th:text="${post.content}">Content...</p>
                                </div>

                                <div th:if="${post.postMediaList != null and !post.postMediaList.empty}" class="w-full mt-3">
                                    <div th:each="media : ${post.postMediaList}">

                                        <img th:if="${media.mediaType.name() == 'IMAGE'}" 
                                             th:src="@{'/uploads/' + ${media.mediaUrl}}" 
                                             class="w-full h-auto object-cover rounded-lg mb-2 border border-gray-100" 
                                             alt="Post Image">
                                    </div>
                                </div>

                                <div class="flex flex-wrap justify-between border-t border-gray-100 mt-2">
                                    <button class="flex flex-1 items-center justify-center gap-2 px-3 py-3 text-text-secondary transition-colors hover:bg-gray-50 hover:text-red-500">
                                        <span class="material-symbols-outlined text-xl">favorite</span>
                                        <p class="text-sm font-medium">Like</p>
                                    </button>
                                    <button class="flex flex-1 items-center justify-center gap-2 px-3 py-3 text-text-secondary transition-colors hover:bg-gray-50 hover:text-secondary-accent">
                                        <span class="material-symbols-outlined text-xl">chat_bubble</span>
                                        <p class="text-sm font-medium">Comment</p>
                                    </button>
                                    <button class="flex flex-1 items-center justify-center gap-2 px-3 py-3 text-text-secondary transition-colors hover:bg-gray-50 hover:text-secondary-accent">
                                        <span class="material-symbols-outlined text-xl">share</span>
                                        <p class="text-sm font-medium">Share</p>
                                    </button>
                                </div>
                            </div>
                            <div th:if="${posts.empty}" class="text-center p-10 text-gray-500">
                                No posts yet. Be the first to share something!
                            </div>
                        </div>
                    </div>
                    <!-- Right Sidebar -->
                    <aside class="hidden lg:col-span-3 lg:block">
                        <div class="sticky top-24 flex flex-col gap-6">
                            <!-- Friend Suggestions -->
                            <div class="rounded-lg bg-container p-4 shadow-sm">
                                <h3 class="mb-4 text-base font-bold text-text-primary">Friend Suggestions</h3>
                                <div class="flex flex-col gap-4">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="h-10 w-10 flex-shrink-0 rounded-full bg-cover bg-center" data-alt="User avatar of Michael Brown" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDLqGkFlmfDDNGISNwg7jeeAnyo9fOI82iL6XoXXKDL3MalRMFCxBTTElNp6EVfNRGGAL-Bs00CTc8z9MaLzoNZ8jCyO42PGu_vbjY-SpAivaYmF8X3vXzCKsv8wBWw1Bkf4_j_xY3zxwUURyYELX6zMuY0Npb5fzxa5LGDwMfdzhin0OsCk2JJ5WxxPkET0pPCvFPvEtB6AhuV4kA1xEK5sjfmkeZ8CDhJQOMlMOHTYTUFvUidLGBXT-Ug8wCJ6mPegZBZBVUK1z-b')"></div>
                                            <div>
                                                <p class="text-sm font-bold text-text-primary">Michael Brown</p>
                                                <p class="text-xs text-text-secondary">@michaelb</p>
                                            </div>
                                        </div>
                                        <button class="h-8 cursor-pointer items-center justify-center rounded-lg bg-secondary-accent px-4 text-xs font-bold text-white transition-opacity hover:opacity-90">Add</button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="h-10 w-10 flex-shrink-0 rounded-full bg-cover bg-center" data-alt="User avatar of Emily Carter" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuA0vvvYdfJfAoY7uUDgj1m2sBnrglQe_XWhVmdsmWXhR1a2oDutver1MS_yDTLaF2hPVVCwebYGAf16RPLy5afgX1OF__R_YtAAoTQ7WSI8tGOSYwCNa9svRDAFjFsMztTEgxwS8i5spgAhjPfe2mXjHLAmMmwGXBZGD4olw_UDxQMpvPmW4dy82JsODf2MNXL2jj24prJyXQKY0rcCcZeJVJdBO12OFCXu1lLAgT-bydDNxWgbeyukQUit-tRuWG8BpIrOB4WdV6lB')"></div>
                                            <div>
                                                <p class="text-sm font-bold text-text-primary">Emily Carter</p>
                                                <p class="text-xs text-text-secondary">@emilyc</p>
                                            </div>
                                        </div>
                                        <button class="h-8 cursor-pointer items-center justify-center rounded-lg bg-secondary-accent px-4 text-xs font-bold text-white transition-opacity hover:opacity-90">Add</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Trending Topics -->
                            <div class="rounded-lg bg-container p-4 shadow-sm">
                                <h3 class="mb-4 text-base font-bold text-text-primary">Trending Topics</h3>
                                <div class="flex flex-col gap-3">
                                    <div>
                                        <p class="text-sm font-bold text-text-primary">#TechInnovation</p>
                                        <p class="text-xs text-text-secondary">15.2k Posts</p>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-text-primary">#FutureOfWork</p>
                                        <p class="text-xs text-text-secondary">8.9k Posts</p>
                                    </div>
                                    <div>
                                        <p class="text-sm font-bold text-text-primary">#CreativeDesign</p>
                                        <p class="text-xs text-text-secondary">6.1k Posts</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>
                </div>
            </main>
            <!-- 1. Container chứa Alert -->
            <div class="fixed bottom-5 right-5 z-50 flex flex-col gap-3 w-full max-w-sm pointer-events-none">
                <div class="pointer-events-auto"><div th:replace="~{fragments/alerts :: success(${successMessage})}"></div></div>
                <div class="pointer-events-auto"><div th:replace="~{fragments/alerts :: error(${errorMessage})}"></div></div>
                <div class="pointer-events-auto"><div th:replace="~{fragments/alerts :: warning(${warningMessage})}"></div></div>
                <div class="pointer-events-auto"><div th:replace="~{fragments/alerts :: info(${infoMessage})}"></div></div>
            </div>

            <!-- 2. QUAN TRỌNG: Nhúng Script xử lý đóng Alert vào đây -->
            <div th:replace="~{fragments/alerts :: alert-script}"></div>
        </div>
    </body>

    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            document.getElementById('fileInput').value = "";
            document.getElementById('image-preview-container').classList.add('hidden');
        }
    </script>
</html>